<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Pesa Dashboard | Transaction Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --primary: #0d6efd;
            --primary-dark: #0b5ed7;
            --secondary: #6c757d;
            --success: #198754;
            --success-light: #d1e7dd;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #212529;
            --card-bg: #ffffff;
            --sidebar-bg: #ffffff;
            --body-bg: #f8fafc;
            --border-color: #e9ecef;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.07);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        [data-theme="dark"] {
            --primary: #3d8bfd;
            --primary-dark: #3a86ff;
            --secondary: #adb5bd;
            --success: #20c997;
            --danger: #ff6b6b;
            --warning: #ffd166;
            --light: #2d3748;
            --dark: #f8f9fa;
            --card-bg: #2d3748;
            --sidebar-bg: #1a202c;
            --body-bg: #1a202c;
            --border-color: #4a5568;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--body-bg);
            color: var(--dark);
            transition: background-color 0.3s ease;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 3rem;
            padding: 0.5rem;
            border-radius: var(--radius-md);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), #6610f2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0.875rem 1rem;
            border-radius: var(--radius-md);
            color: var(--secondary);
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: var(--primary);
            color: white;
            transform: translateX(4px);
        }

        .nav-link i {
            font-size: 1.1rem;
            width: 24px;
        }

        .main-content {
            margin-left: 280px;
            padding: 2rem;
            transition: margin-left 0.3s ease;
        }

        /* Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .header-title h1 {
            font-weight: 700;
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
            color: var(--dark);
        }

        .header-title p {
            color: var(--secondary);
            margin: 0;
            font-size: 0.9rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Date Filter */
        .date-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .date-filter i {
            color: var(--secondary);
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            position: relative;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-indicator::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: var(--success);
        }

        .status-indicator.connected::after {
            background: var(--success);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .stat-card.revenue::before {
            background: linear-gradient(to bottom, var(--primary), #6610f2);
        }

        .stat-card.successful::before {
            background: linear-gradient(to bottom, var(--success), #0d6efd);
        }

        .stat-card.failed::before {
            background: linear-gradient(to bottom, var(--danger), #fd7e14);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-icon.revenue {
            background: linear-gradient(135deg, var(--primary), #6610f2);
        }

        .stat-icon.successful {
            background: linear-gradient(135deg, var(--success), #0d6efd);
        }

        .stat-icon.failed {
            background: linear-gradient(135deg, var(--danger), #fd7e14);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin: 0.5rem 0;
            font-feature-settings: "tnum";
        }

        .stat-label {
            color: var(--secondary);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            background: var(--success-light);
            color: var(--success);
            margin-top: 0.5rem;
        }

        /* Dashboard Sections */
        .dashboard-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .dashboard-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Main Table Card */
        .main-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .card-header {
            padding: 1.5rem;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .table-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
        }

        .table {
            margin: 0;
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }

        .table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table thead th {
            background: var(--light);
            color: var(--secondary);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem 1.5rem;
            border: none;
            white-space: nowrap;
        }

        .table tbody tr {
            transition: all 0.2s ease;
            border-top: 1px solid var(--border-color);
        }

        .table tbody tr:hover {
            background: var(--light);
        }

        .table tbody td {
            padding: 1.25rem 1.5rem;
            vertical-align: middle;
            border: none;
            font-size: 0.875rem;
        }

        .row-update {
            animation: highlight 2s ease-out;
        }

        @keyframes highlight {
            0% {
                background: var(--success-light);
            }

            100% {
                background: transparent;
            }
        }

        /* Status Badges */
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge.success {
            background: rgba(25, 135, 84, 0.1);
            color: var(--success);
        }

        .status-badge.pending {
            background: rgba(255, 193, 7, 0.1);
            color: #e6a700;
        }

        .status-badge.cancelled,
        .status-badge.failed {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }

        .status-badge.reversed {
            background: rgba(108, 117, 125, 0.1);
            color: var(--secondary);
        }

        /* Reversal Button */
        .btn-reverse {
            background: linear-gradient(135deg, var(--danger), #dc3545);
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-sm);
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-reverse:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        /* Analytics Section */
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .time-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .time-filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--secondary);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-filter-btn:hover,
        .time-filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .analytics-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            height: 100%;
        }

        .analytics-card h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 1rem;
        }

        .analytics-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            background: var(--light);
            border-radius: var(--radius-md);
            border: 2px dashed var(--border-color);
        }

        /* Theme Toggle */
        .theme-toggle {
            width: 48px;
            height: 24px;
            background: var(--light);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        [data-theme="dark"] .theme-toggle::after {
            transform: translateX(24px);
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-logout {
            background: linear-gradient(135deg, var(--danger), #c82333);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            color: white;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--card-bg);
            border-left: 4px solid var(--success);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1100;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2s forwards;
            max-width: 350px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                width: 240px;
                padding: 1.5rem 1rem;
            }

            .main-content {
                margin-left: 240px;
                padding: 1.5rem;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .table-container {
                max-height: 400px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }
        }
    </style>
</head>

<body>
    <!-- Mobile Menu Toggle -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon">
                <i class="bi bi-lightning-charge-fill"></i>
            </div>
            <div class="logo-text">M-Pesa Admin</div>
        </div>

        <nav class="nav flex-column">
            <div class="nav-item">
                <button class="nav-link active" onclick="showSection('dashboard')">
                    <i class="bi bi-speedometer2"></i>
                    Dashboard
                </button>
            </div>
            <div class="nav-item">
                <button class="nav-link" onclick="showSection('transactions')">
                    <i class="bi bi-cash-stack"></i>
                    All Transactions
                </button>
            </div>
            <div class="nav-item">
                <button class="nav-link" onclick="showSection('analytics')">
                    <i class="bi bi-bar-chart"></i>
                    Analytics
                </button>
            </div>
        </nav>

        <div class="mt-auto">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <span class="text-muted small">Theme</span>
                <div class="theme-toggle" onclick="toggleTheme()"></div>
            </div>
            <div class="connection-status">
                <div id="connection-status" class="status-indicator"></div>
                <div>
                    <div class="small text-muted">Connection</div>
                    <div id="status-text" class="small">Initializing...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="dashboard-section active">
            <!-- Header -->
            <div class="dashboard-header">
                <div class="header-title">
                    <h1>Today's Dashboard</h1>
                    <p>Real-time monitoring of today's M-Pesa transactions</p>
                </div>

                <div class="header-actions">
                    <div class="date-filter">
                        <i class="bi bi-calendar"></i>
                        <span id="current-date"></span>
                    </div>
                    <button onclick="logout()" class="btn-logout">
                        <i class="bi bi-box-arrow-right"></i>
                        Logout
                    </button>
                </div>
            </div>

            <!-- Stats Grid (Today's Data Only) -->
            <div class="stats-grid">
                <div class="stat-card revenue">
                    <div class="stat-icon revenue">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <div class="stat-label">Today's Revenue</div>
                    <div class="stat-value" id="today-revenue">KES 0</div>
                    <div class="stat-change">
                        <i class="bi bi-graph-up-arrow"></i>
                        <span>Live Updates</span>
                    </div>
                </div>

                <div class="stat-card successful">
                    <div class="stat-icon successful">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-label">Successful Today</div>
                    <div class="stat-value" id="today-successful">0</div>
                    <div class="stat-change">
                        <i class="bi bi-clock-history"></i>
                        <span>Real-time</span>
                    </div>
                </div>

                <div class="stat-card failed">
                    <div class="stat-icon failed">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <div class="stat-label">Failed/Cancelled Today</div>
                    <div class="stat-value" id="today-failed">0</div>
                    <div class="stat-change">
                        <i class="bi bi-exclamation-circle"></i>
                        <span>Today</span>
                    </div>
                </div>
            </div>

            <!-- Today's Transactions Table -->
            <div class="main-card">
                <div class="card-header">
                    <h2>
                        <i class="bi bi-list-check"></i>
                        Today's Transactions
                    </h2>
                    <div class="table-controls">
                        <span class="text-muted small" id="today-count">0 transactions</span>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Phone Number</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Request ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="today-table-body">
                            <!-- Today's transactions will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- All Transactions Section -->
        <div id="transactions-section" class="dashboard-section">
            <div class="dashboard-header">
                <div class="header-title">
                    <h1>All Transactions</h1>
                    <p>Complete history of all M-Pesa transactions</p>
                </div>

                <div class="header-actions">
                    <button onclick="logout()" class="btn-logout">
                        <i class="bi bi-box-arrow-right"></i>
                        Logout
                    </button>
                </div>
            </div>

            <div class="main-card">
                <div class="card-header">
                    <h2>
                        <i class="bi bi-database"></i>
                        Transaction History
                    </h2>
                    <div class="table-controls">
                        <span class="text-muted small" id="all-count">Loading...</span>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Phone Number</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Request ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="all-transactions-body">
                            <!-- All transactions will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics-section" class="dashboard-section">
            <div class="dashboard-header">
                <div class="header-title">
                    <h1>Analytics & Insights</h1>
                    <p>Performance analysis and revenue trends</p>
                </div>

                <div class="header-actions">
                    <div class="time-filter">
                        <button class="time-filter-btn active" onclick="filterAnalytics('day')">Today</button>
                        <button class="time-filter-btn" onclick="filterAnalytics('week')">This Week</button>
                        <button class="time-filter-btn" onclick="filterAnalytics('month')">This Month</button>
                    </div>
                    <button onclick="logout()" class="btn-logout">
                        <i class="bi bi-box-arrow-right"></i>
                        Logout
                    </button>
                </div>
            </div>

            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>
                        <i class="bi bi-graph-up"></i>
                        Revenue Trend
                    </h3>
                    <div class="analytics-placeholder" id="revenue-chart">
                        <div class="text-center">
                            <i class="bi bi-bar-chart" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                            <p>Revenue chart will be displayed here</p>
                        </div>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3>
                        <i class="bi bi-pie-chart"></i>
                        Transaction Distribution
                    </h3>
                    <div class="analytics-placeholder" id="distribution-chart">
                        <div class="text-center">
                            <i class="bi bi-pie-chart-fill" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                            <p>Transaction distribution chart</p>
                        </div>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3>
                        <i class="bi bi-cash-stack"></i>
                        Total Company Gain
                    </h3>
                    <div class="text-center py-5">
                        <div class="stat-value" id="total-gain">KES 0</div>
                        <p class="text-muted mt-2">All-time total revenue from successful transactions</p>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Successful</span>
                            <span id="success-count">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Failed</span>
                            <span id="failed-count">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Cancelled</span>
                            <span id="cancelled-count">0</span>
                        </div>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3>
                        <i class="bi bi-calendar-week"></i>
                        Performance Summary
                    </h3>
                    <div class="mt-3">
                        <div class="mb-3">
                            <div class="small text-muted mb-1">Today's Performance</div>
                            <div class="d-flex justify-content-between">
                                <span>Revenue:</span>
                                <strong id="today-performance">KES 0</strong>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="small text-muted mb-1">Weekly Average</div>
                            <div class="d-flex justify-content-between">
                                <span>Daily Revenue:</span>
                                <strong id="weekly-avg">KES 0</strong>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="small text-muted mb-1">Monthly Total</div>
                            <div class="d-flex justify-content-between">
                                <span>Revenue:</span>
                                <strong id="monthly-total">KES 0</strong>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="small text-muted mb-1">Success Rate</div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" id="success-rate" style="width: 0%"></div>
                            </div>
                            <div class="text-end mt-1 small" id="success-rate-text">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification" style="display: none;">
        <i class="bi bi-bell-fill" style="color: var(--success);"></i>
        <div>
            <div class="small fw-bold">New Transaction</div>
            <div class="small text-muted">Update detected, refreshing...</div>
        </div>
    </div>

    <!-- Audio -->
    <audio id="success-chime" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        preload="auto"></audio>

    <!-- Data for Dashboard -->
    <script id="transactions-data" type="application/json">
        <%- JSON.stringify(transactions || []) %>
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // LOGOUT FUNCTION
        function logout() {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.open("GET", "/admin/dashboard", true, "logout", "logout");
            xmlhttp.send();
            xmlhttp.onreadystatechange = function () {
                if (xmlhttp.readyState == 4) {
                    window.location.href = "/";
                }
            }
        }

        // Reversal Function
        async function initiateReversal(receipt, amount) {
            const confirmed = confirm(`Are you sure you want to reverse ${amount} KES for transaction ${receipt}?`);
            
            if (!confirmed) return;

            try {
                const response = await fetch('/admin/reversal/initiate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transactionId: receipt,
                        amount: amount
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert("Reversal request sent! Status: " + data.ResponseDescription);
                    // Reload to see updated status
                    location.reload();
                } else {
                    alert("Error: " + (data.errorMessage || "Failed to initiate reversal"));
                }
            } catch (error) {
                console.error("Reversal Error:", error);
                alert("An error occurred while processing the reversal.");
            }
        }

        // Sidebar Toggle for Mobile
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }

        // Section Navigation
        function showSection(sectionId, event) {
            // Update active nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            // Show selected section
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${sectionId}-section`).classList.add('active');

            // Close sidebar on mobile
            const sidebar = document.querySelector('.sidebar');
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        }

        // Analytics Filter
        function filterAnalytics(filter, event) {
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            // Update analytics based on filter
            updateAnalytics(filter);
        }

        // Initialize date display
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Parse EJS data passed from server
        const rawTransactions = JSON.parse(document.getElementById('transactions-data').textContent);

        const allTransactions = rawTransactions.length > 0 ? rawTransactions.map(t => ({
            id: t.checkout_request_id,
            receipt: t.mpesa_receipt || t.checkout_request_id,
            phone: t.phone_number || t.phone,
            amount: parseFloat(t.amount) || 0,
            status: t.status,
            date: new Date(t.created_at),
            timestamp: t.created_at
        })) : [
            {
                id: 'ws_CO_123456789',
                receipt: 'REC123456',
                phone: '254712345678',
                amount: 1000,
                status: 'success',
                date: new Date(),
                timestamp: new Date().toISOString()
            },
            {
                id: 'ws_CO_987654321',
                receipt: 'REC654321',
                phone: '254723456789',
                amount: 500,
                status: 'failed',
                date: new Date(Date.now() - 86400000),
                timestamp: new Date(Date.now() - 86400000).toISOString()
            }
        ];

        // Filter today's transactions
        function getTodayTransactions() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            return allTransactions.filter(t => {
                const transDate = new Date(t.date);
                transDate.setHours(0, 0, 0, 0);
                return transDate.getTime() === today.getTime();
            });
        }

        // Calculate today's stats
        function updateTodayStats() {
            const todayTransactions = getTodayTransactions();
            const todaySuccessful = todayTransactions.filter(t => t.status === 'success');
            const todayFailedCancelled = todayTransactions.filter(t => t.status === 'failed' || t.status === 'cancelled');

            const todayRevenue = todaySuccessful.reduce((sum, t) => sum + t.amount, 0);

            // Update UI
            document.getElementById('today-revenue').textContent = `KES ${todayRevenue.toLocaleString()}`;
            document.getElementById('today-successful').textContent = todaySuccessful.length;
            document.getElementById('today-failed').textContent = todayFailedCancelled.length;
            document.getElementById('today-count').textContent = `${todayTransactions.length} transactions`;

            // Populate today's table
            const todayTableBody = document.getElementById('today-table-body');
            todayTableBody.innerHTML = '';

            if (todayTransactions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="text-center py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem; color: var(--secondary);"></i>
                        <p class="mt-2 text-muted">No transactions today</p>
                    </td>
                `;
                todayTableBody.appendChild(row);
            } else {
                todayTransactions.forEach(t => {
                    const row = document.createElement('tr');
                    row.id = `row-${t.id}`;

                    const time = new Date(t.timestamp);
                    const statusClass = t.status === 'success' ? 'success' :
                        (t.status === 'pending' ? 'pending' :
                            (t.status === 'failed' ? 'failed' : 
                             t.status === 'reversed' ? 'reversed' : 'cancelled'));
                    const statusIcon = t.status === 'success' ? 'check-circle' :
                        (t.status === 'pending' ? 'clock' : 
                         t.status === 'reversed' ? 'arrow-counterclockwise' : 'x-circle');
                    const statusText = t.status.charAt(0).toUpperCase() + t.status.slice(1);

                    row.innerHTML = `
                        <td>
                            <div class="small">${time.toLocaleTimeString()}</div>
                        </td>
                        <td>
                            <i class="bi bi-phone me-1"></i>
                            ${t.phone}
                        </td>
                        <td>
                            <strong>KES ${t.amount.toLocaleString()}</strong>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                <i class="bi bi-${statusIcon}"></i>
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <code class="small text-muted">
                                ${t.receipt.substring(0, 8)}...
                            </code>
                        </td>
                        <td>
                            ${t.status === 'success' ? 
                                `<button class="btn-reverse" onclick="initiateReversal('${t.receipt}', ${t.amount})">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                    Reverse
                                </button>` : 
                             t.status === 'reversed' ? 
                                `<span class="text-muted small">Reversed</span>` : 
                                ''}
                        </td>
                    `;
                    todayTableBody.appendChild(row);
                });
            }
        }

        // Populate all transactions
        function updateAllTransactions() {
            const allTableBody = document.getElementById('all-transactions-body');
            allTableBody.innerHTML = '';

            document.getElementById('all-count').textContent = `${allTransactions.length} total transactions`;

            if (allTransactions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="text-center py-4">
                        <i class="bi bi-database-x" style="font-size: 2rem; color: var(--secondary);"></i>
                        <p class="mt-2 text-muted">No transactions found</p>
                    </td>
                `;
                allTableBody.appendChild(row);
            } else {
                allTransactions.forEach(t => {
                    const row = document.createElement('tr');

                    const time = new Date(t.timestamp);
                    const statusClass = t.status === 'success' ? 'success' :
                        (t.status === 'pending' ? 'pending' :
                            (t.status === 'failed' ? 'failed' : 
                             t.status === 'reversed' ? 'reversed' : 'cancelled'));
                    const statusIcon = t.status === 'success' ? 'check-circle' :
                        (t.status === 'pending' ? 'clock' : 
                         t.status === 'reversed' ? 'arrow-counterclockwise' : 'x-circle');
                    const statusText = t.status.charAt(0).toUpperCase() + t.status.slice(1);

                    row.innerHTML = `
                        <td>
                            ${time.toLocaleDateString()}
                        </td>
                        <td>
                            ${time.toLocaleTimeString()}
                        </td>
                        <td>
                            <i class="bi bi-phone me-1"></i>
                            ${t.phone}
                        </td>
                        <td>
                            <strong>KES ${t.amount.toLocaleString()}</strong>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                <i class="bi bi-${statusIcon}"></i>
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <code class="small text-muted">
                                ${t.receipt ? t.receipt.substring(0, 8) + '...' : t.id.substring(0, 8) + '...'}
                            </code>
                        </td>
                        <td>
                            ${t.status === 'success' ? 
                                `<button class="btn-reverse" onclick="initiateReversal('${t.receipt}', ${t.amount})">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                    Reverse
                                </button>` : 
                             t.status === 'reversed' ? 
                                `<span class="text-muted small">Reversed</span>` : 
                                ''}
                        </td>
                    `;
                    allTableBody.appendChild(row);
                });
            }
        }

        // Calculate analytics
        function updateAnalytics(filter = 'day') {
            const now = new Date();
            let filteredTransactions = allTransactions;

            if (filter === 'day') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filteredTransactions = allTransactions.filter(t => new Date(t.date) >= today);
            } else if (filter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredTransactions = allTransactions.filter(t => new Date(t.date) >= weekAgo);
            } else if (filter === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredTransactions = allTransactions.filter(t => new Date(t.date) >= monthAgo);
            }

            const successful = filteredTransactions.filter(t => t.status === 'success');
            const failed = filteredTransactions.filter(t => t.status === 'failed');
            const cancelled = filteredTransactions.filter(t => t.status === 'cancelled');
            const reversed = filteredTransactions.filter(t => t.status === 'reversed');

            const totalRevenue = successful.reduce((sum, t) => sum + t.amount, 0);

            // Calculate success rate
            const totalProcessed = successful.length + failed.length + cancelled.length + reversed.length;
            const successRate = totalProcessed > 0 ? (successful.length / totalProcessed * 100) : 0;

            // Update analytics UI
            document.getElementById('total-gain').textContent = `KES ${totalRevenue.toLocaleString()}`;
            document.getElementById('success-count').textContent = successful.length;
            document.getElementById('failed-count').textContent = failed.length;
            document.getElementById('cancelled-count').textContent = cancelled.length;

            // Current Performance
            const todaySuccessful = allTransactions.filter(t => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const d = new Date(t.date);
                d.setHours(0, 0, 0, 0);
                return d.getTime() === today.getTime() && t.status === 'success';
            });
            const todayPerformance = todaySuccessful.reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('today-performance').textContent = `KES ${todayPerformance.toLocaleString()}`;

            // Calculate average daily revenue (last 7 days)
            const last7Days = allTransactions.filter(t => {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return new Date(t.date) > weekAgo;
            });

            const last7DaysRevenue = last7Days
                .filter(t => t.status === 'success')
                .reduce((sum, t) => sum + t.amount, 0);
            const dailyAvg = last7DaysRevenue / 7;
            document.getElementById('weekly-avg').textContent = `KES ${dailyAvg.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;

            // Monthly total (last 30 days)
            const last30Days = allTransactions.filter(t => {
                const monthAgo = new Date();
                monthAgo.setDate(monthAgo.getDate() - 30);
                return new Date(t.date) > monthAgo;
            });

            const monthlyTotal = last30Days
                .filter(t => t.status === 'success')
                .reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('monthly-total').textContent = `KES ${monthlyTotal.toLocaleString()}`;

            // Update success rate bar
            document.getElementById('success-rate').style.width = `${successRate}%`;
            document.getElementById('success-rate-text').textContent = `${successRate.toFixed(1)}%`;

            // Draw Charts
            drawRevenueChart(filteredTransactions);
            drawDistributionChart(successful.length, failed.length, cancelled.length, reversed.length);
        }

        function drawRevenueChart(transactions) {
            const chart = document.getElementById('revenue-chart');
            chart.innerHTML = '';
            chart.style.display = 'flex';
            chart.style.alignItems = 'flex-end';
            chart.style.gap = '10px';
            chart.style.padding = '10px';
            chart.style.border = 'none';

            // Group by date
            const grouped = {};
            transactions.filter(t => t.status === 'success').forEach(t => {
                const d = new Date(t.date).toLocaleDateString();
                grouped[d] = (grouped[d] || 0) + t.amount;
            });

            const dates = Object.keys(grouped).sort().slice(-7);
            const max = Math.max(...Object.values(grouped), 1);

            if (dates.length === 0) {
                chart.innerHTML = '<div class="text-muted">No revenue data for this period</div>';
                return;
            }

            dates.forEach(date => {
                const val = grouped[date];
                const height = (val / max) * 100;
                const bar = document.createElement('div');
                bar.className = 'flex-fill';
                bar.style.height = `${Math.max(height, 5)}%`;
                bar.style.background = 'var(--primary)';
                bar.style.borderRadius = '4px 4px 0 0';
                bar.title = `${date}: KES ${val}`;
                chart.appendChild(bar);
            });
        }

        function drawDistributionChart(s, f, c, r) {
            const chart = document.getElementById('distribution-chart');
            chart.innerHTML = '';
            const total = s + f + c + r || 1;
            const sp = (s / total) * 100;
            const fp = (f / total) * 100;
            const cp = (c / total) * 100;
            const rp = (r / total) * 100;

            chart.innerHTML = `
                <div class="w-100 h-100 d-flex flex-column justify-content-center px-3">
                    <div class="progress mb-2" style="height: 24px;">
                        <div class="progress-bar bg-success" style="width: ${sp}%" title="Success"></div>
                        <div class="progress-bar bg-danger" style="width: ${fp}%" title="Failed"></div>
                        <div class="progress-bar bg-secondary" style="width: ${cp}%" title="Cancelled"></div>
                        <div class="progress-bar bg-warning" style="width: ${rp}%" title="Reversed"></div>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span><i class="bi bi-circle-fill text-success me-1"></i> Success</span>
                        <span><i class="bi bi-circle-fill text-danger me-1"></i> Failed</span>
                        <span><i class="bi bi-circle-fill text-secondary me-1"></i> Cancelled</span>
                        <span><i class="bi bi-circle-fill text-warning me-1"></i> Reversed</span>
                    </div>
                </div>
            `;
        }

        // Supabase Configuration
        const URL = "<%= env.SUPABASE_URL %>";
        const KEY = "<%= env.SUPABASE_ANON_KEY %>";

        const statusIndicator = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        const chime = document.getElementById('success-chime');
        const notification = document.getElementById('notification');

        // Initialize Supabase only if URL and KEY are provided
        let supabaseClient;
        if (URL && KEY && URL !== "<%= env.SUPABASE_URL %>" && KEY !== "<%= env.SUPABASE_ANON_KEY %>") {
            supabaseClient = supabasejs.createClient(URL, KEY);

            // Real-time Updates
            const channel = supabaseClient
                .channel('mpesa-monitor')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'transactions' },
                    (payload) => {
                        if (payload.new) {
                            // Play chime for successful payments
                            if (payload.new.status === 'success') {
                                chime.play().catch(() => { });
                            }

                            // Update local data array
                            const existingIndex = allTransactions.findIndex(t => t.id === payload.new.checkout_request_id);
                            const newTx = {
                                id: payload.new.checkout_request_id,
                                receipt: payload.new.mpesa_receipt || payload.new.checkout_request_id,
                                phone: payload.new.phone_number || payload.new.phone,
                                amount: parseFloat(payload.new.amount) || 0,
                                status: payload.new.status,
                                date: new Date(payload.new.created_at),
                                timestamp: payload.new.created_at
                            };

                            if (existingIndex !== -1) {
                                allTransactions[existingIndex] = newTx;
                            } else {
                                allTransactions.unshift(newTx);
                            }

                            // Refresh UI
                            updateTodayStats();
                            updateAllTransactions();
                            updateAnalytics();

                            // Show notification
                            notification.style.display = 'flex';
                            setTimeout(() => {
                                notification.style.display = 'none';
                            }, 3000);
                        }
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        statusIndicator.classList.add('connected');
                        statusText.textContent = 'Live Connected';
                    } else {
                        statusIndicator.classList.remove('connected');
                        statusText.textContent = 'Connecting...';
                    }
                });
        } else {
            statusText.textContent = 'Connection Disabled';
        }

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function () {
            statusIndicator.classList.add('connected');
            statusText.textContent = 'Live Connected';
            updateTodayStats();
            updateAllTransactions();
            updateAnalytics();
        });
    </script>
</body>

</html>